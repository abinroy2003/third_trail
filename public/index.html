<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet">

    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            min-height: 100vh;
            display: flex;
            margin: 0;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: #343a40;
            color: white;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            transition: all 0.3s ease-in-out;
            z-index: 1050;
            overflow-y: auto;
        }

        .sidebar h4 {
            margin: 0;
            padding: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 12px 15px;
            gap: 10px;
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar a:hover {
            background-color: #495057;
        }

        .logout-btn-container {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            padding: 0 15px;
        }

        /* Desktop: full sidebar */
        @media (min-width: 1200px) {
            .sidebar {
                width: 250px;
            }
            .content {
                margin-left: 250px;
            }
            .navbar {
                display: none !important;
            }
        }

        /* Tablet: mini sidebar (icons only) */
        @media (min-width: 768px) and (max-width: 1199px) {
            .sidebar {
                width: 70px;
            }
            .sidebar h4 {
                font-size: 0;
                padding: 1rem 0.5rem;
            }
            .sidebar a span {
                display: none;
            }
            .content {
                margin-left: 70px;
            }
            .navbar {
                display: none !important;
            }
            .logout-btn-container .logout-text {
                display: none;
            }
        }

        /* Mobile: sidebar with hamburger menu */
        @media (max-width: 767px) {
            .sidebar {
                width: 250px;
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .content {
                margin-left: 0;
                margin-top: 56px;
            }
            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1040;
            }
            .overlay.active {
                display: block;
            }
            .sortable {
                padding-right: 30px;
            }
            .sortable::after {
                right: 10px;
            }
        }

        .content {
            flex: 1;
            padding: 20px;
            background: #f8f9fa;
        }

        #calendar {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 100%;
        }

        #clock {
            font-family: monospace;
            font-size: 1.2rem;
        }

        .fc {
            font-size: 0.85em;
        }
        .fc .fc-daygrid-day {
            height: 2.5em;
        }
        .fc .fc-daygrid-day-frame {
            padding: 2px;
        }

        .sortable {
            cursor: pointer;
            position: relative;
            padding-right: 20px;
        }
        .sortable::after {
            content: '\f0dc';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 8px;
            opacity: 0.5;
        }
        .sortable.asc::after {
            content: '\f0de';
            opacity: 1;
        }
        .sortable.desc::after {
            content: '\f0dd';
            opacity: 1;
        }

        .pagination {
            margin-top: 15px;
            justify-content: center;
        }

        .logout-btn-container {
            padding: 10px 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .hidden {
            display: none;
        }

        .dropdown-menu {
            min-width: 200px;
        }

        /* Ensure calendar responsiveness */
        @media (max-width: 767px) {
            .fc {
                font-size: 0.75em;
            }
            .fc .fc-daygrid-day {
                height: 2em;
            }
            #calendar {
                min-height: 300px;
            }
        }

        /* Departments table responsiveness */
        .members-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            max-height: 100px;
            overflow-y: auto;
        }
        .members-container .badge {
            font-size: 0.9em;
            padding: 5px 8px;
        }
        .members-container .remove-member-btn {
            padding: 2px 5px;
            font-size: 0.8em;
            line-height: 1;
        }
        @media (max-width: 767px) {
            .table-responsive {
                font-size: 0.85em;
            }
            .members-container {
                max-height: 80px;
                gap: 3px;
            }
            .members-container .badge {
                font-size: 0.75em;
                padding: 4px 6px;
            }
            .members-container .remove-member-btn {
                font-size: 0.7em;
                padding: 1px 4px;
            }
            .action-buttons {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            .action-buttons .btn {
                font-size: 0.85em;
                padding: 5px;
            }
            .modal-dialog {
                max-width: 90%;
                margin: 1rem auto;
            }
            .modal-body select.form-select {
                font-size: 0.9em;
            }
            .modal-footer .btn {
                font-size: 0.9em;
                padding: 6px 12px;
            }
        }
        @media (min-width: 768px) and (max-width: 1199px) {
            .members-container {
                max-height: 90px;
            }
            .members-container .badge {
                font-size: 0.85em;
            }
            .action-buttons .btn {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>

    <div class="sidebar" id="sidebar">
        <h4 class="p-3 border-bottom"><i class="fas fa-building company-logo"></i> <span class="company-text">Company Name</span></h4>
        <a href="#" id="dashboardLink"><i class="fas fa-chart-line"></i> <span>Dashboard</span></a>
        <a href="#" id="departmentLink"><i class="fas fa-building"></i> <span>Department</span></a>
        <a href="#" id="userPermissionLink"><i class="fas fa-key"></i> <span>User Permission</span></a>
        <a href="#" id="profileLink"><i class="fas fa-user"></i> <span>Profile</span></a>
        <div class="logout-btn-container">
            <button id="logoutBtn" class="btn btn-danger btn-sm w-100"><i class="fa-solid fa-arrow-right-from-bracket"></i> <span class="logout-text">Logout</span></button>
        </div>
    </div>

    <nav class="navbar navbar-dark bg-dark fixed-top d-lg-none">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" id="menuBtn">
                <span class="navbar-toggler-icon"></span>
            </button>
            <span class="navbar-brand">üè¢ Company Name</span>
        </div>
    </nav>

    <div class="content" id="mainContent"></div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <!-- Reminder Toast -->
        <div id="reminderToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-bell me-2"></i>
                <strong class="me-auto">Reminder</strong>
                <small id="reminderToastTimestamp"></small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                This is your 10-second reminder!
            </div>
        </div>
        <!-- Login Toast -->
        <div id="loginToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-sign-in-alt me-2"></i>
                <strong class="me-auto">Login</strong>
                <small id="loginToastTimestamp"></small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Successfully logged in!
            </div>
        </div>
        <!-- Logout Toast -->
        <div id="logoutToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-sign-out-alt me-2"></i>
                <strong class="me-auto">Logout</strong>
                <small id="logoutToastTimestamp"></small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Successfully logged out!
            </div>
        </div>
        <!-- Assign Member Toast -->
        <div id="assignMemberToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-user-plus me-2"></i>
                <strong class="me-auto">Member Assignment</strong>
                <small id="assignMemberToastTimestamp"></small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Member assigned successfully!
            </div>
        </div>
        <!-- Remove Member Toast -->
        <div id="removeMemberToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-user-minus me-2"></i>
                <strong class="me-auto">Member Removal</strong>
                <small id="removeMemberToastTimestamp"></small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Member removed successfully!
            </div>
        </div>
        <!-- Deactivate Department Toast -->
        <div id="deactivateDeptToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-building me-2"></i>
                <strong class="me-auto">Department deleted</strong>
                <small id="deactivateDeptToastTimestamp"></small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Department deleted successfully!
            </div>
        </div>
    </div>

    <!-- Delete Warning Modal -->
    <div class="modal fade" id="deleteDeptModal" tabindex="-1" aria-labelledby="deleteDeptModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="deleteDeptModalLabel">Confirm deleted</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this department? 
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">deleted</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Member Modal -->
    <div class="modal fade" id="assignMemberModal" tabindex="-1" aria-labelledby="assignMemberModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="assignMemberModalLabel">Assign Member to Department</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <select id="userSelect" class="form-select mb-3">
                        <option value="">Select a user</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmAssignBtn">Assign</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentUser = null;
        let deptChartInstance = null;
        let roleChartInstance = null;
        let calendar = null;
        let clockInterval = null;

        function toggleSidebar() {
            const sidebar = document.getElementById("sidebar");
            const overlay = document.getElementById("overlay");
            sidebar.classList.toggle("active");
            overlay.classList.toggle("active");
        }

        document.getElementById("overlay")?.addEventListener("click", toggleSidebar);
        document.getElementById("menuBtn")?.addEventListener("click", toggleSidebar);

        document.querySelectorAll(".sidebar a").forEach(link => {
            link.addEventListener("click", () => {
                if (window.innerWidth <= 767) {
                    toggleSidebar();
                }
            });
        });

        function getToken() {
            return localStorage.getItem("token");
        }

        async function fetchCurrentUser() {
            const token = getToken();
            if (!token) {
                currentUser = null;
                return null;
            }

            try {
                const res = await fetch("http://localhost:3000/me", {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (!res.ok) {
                    currentUser = null;
                    return null;
                }
                currentUser = await res.json();
                return currentUser;
            } catch (err) {
                console.error("Error fetching user:", err);
                return null;
            }
        }

        function showLoginRequiredMessage() {
            document.getElementById("mainContent").innerHTML = `
                <h2>üîí Please log in</h2>
                <p>You must log in to view this section.</p>
            `;
            if (window.innerWidth <= 767) {
                document.getElementById("sidebar").classList.remove("active");
                document.getElementById("overlay").classList.remove("active");
            }
        }

        // Toast Functionality
        function showErrorToast(message) {
            const errorToastEl = document.createElement('div');
            errorToastEl.className = 'toast';
            errorToastEl.setAttribute('role', 'alert');
            errorToastEl.setAttribute('aria-live', 'assertive');
            errorToastEl.setAttribute('aria-atomic', 'true');
            errorToastEl.innerHTML = `
                <div class="toast-header">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong class="me-auto">Error</strong>
                    <small>${new Date().getMinutes().toString().padStart(2, '0')}:${new Date().getSeconds().toString().padStart(2, '0')}</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">${message}</div>
            `;
            document.querySelector('.toast-container').appendChild(errorToastEl);
            const errorToast = new bootstrap.Toast(errorToastEl);
            errorToast.show();
            setTimeout(() => errorToastEl.remove(), 5000);
        }

        function initializeToast() {
            const reminderToastEl = document.getElementById('reminderToast');
            const reminderToast = new bootstrap.Toast(reminderToastEl);

            function showReminderToast() {
                const now = new Date();
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                document.getElementById('reminderToastTimestamp').textContent = `${minutes}:${seconds}`;
                reminderToast.show();
            }

            showReminderToast();
            setInterval(showReminderToast, 100000);
        }

        function showLoginToast() {
            const loginToastEl = document.getElementById('loginToast');
            const loginToast = new bootstrap.Toast(loginToastEl);
            const now = new Date();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('loginToastTimestamp').textContent = `${minutes}:${seconds}`;
            loginToast.show();
        }

        function showLogoutToast() {
            const logoutToastEl = document.getElementById('logoutToast');
            const logoutToast = new bootstrap.Toast(logoutToastEl);
            const now = new Date();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('logoutToastTimestamp').textContent = `${minutes}:${seconds}`;
            logoutToast.show();
        }

        function showAssignMemberToast() {
            const assignToastEl = document.getElementById('assignMemberToast');
            const assignToast = new bootstrap.Toast(assignToastEl);
            const now = new Date();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('assignMemberToastTimestamp').textContent = `${minutes}:${seconds}`;
            assignToast.show();
        }

        function showRemoveMemberToast() {
            const removeToastEl = document.getElementById('removeMemberToast');
            const removeToast = new bootstrap.Toast(removeToastEl);
            const now = new Date();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('removeMemberToastTimestamp').textContent = `${minutes}:${seconds}`;
            removeToast.show();
        }

        function showDeactivateDeptToast() {
            const deactivateToastEl = document.getElementById('deactivateDeptToast');
            const deactivateToast = new bootstrap.Toast(deactivateToastEl);
            const now = new Date();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('deactivateDeptToastTimestamp').textContent = `${minutes}:${seconds}`;
            deactivateToast.show();
        }

        async function handleMenuClick(loaderFunction) {
            const user = await fetchCurrentUser();
            if (!user) {
                showLoginRequiredMessage();
                return;
            }
            loaderFunction();
        }

        async function loadUserPermissionsOverview(page = 1, roleFilter = '') {
            const token = getToken();
            if (!token) return showLoginRequiredMessage();

            const defaultColumns = { username: true, role: true, action: true };
            let visibleColumns = JSON.parse(localStorage.getItem("visibleColumns")) || defaultColumns;
            if (!visibleColumns.username && !visibleColumns.role && !visibleColumns.action) {
                visibleColumns = defaultColumns;
                localStorage.setItem("visibleColumns", JSON.stringify(visibleColumns));
            }

            const usersPerPage = 2;
            let users, totalPages;
            try {
                const queryParams = new URLSearchParams({ page: page, limit: usersPerPage });
                if (roleFilter) queryParams.append('role', roleFilter);
                const res = await fetch(`http://localhost:3000/users?${queryParams.toString()}`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (!res.ok) {
                    document.getElementById("mainContent").innerHTML = `<p class="text-danger">‚ö†Ô∏è Failed to load users</p>`;
                    return;
                }

                const data = await res.json();
                if (!Array.isArray(data.users)) {
                    console.error("Expected users to be an array, got:", data.users);
                    document.getElementById("mainContent").innerHTML = `<p class="text-danger">‚ö†Ô∏è Invalid user data</p>`;
                    return;
                }
                users = data.users;
                totalPages = data.totalPages || Math.ceil(data.totalUsers / usersPerPage);
            } catch (err) {
                console.error("Error fetching users:", err);
                document.getElementById("mainContent").innerHTML = `<p class="text-danger">‚ö†Ô∏è Error fetching users</p>`;
                return;
            }

            let html = `
                <h2>User Permissions</h2>
                <div class="mb-3 d-flex gap-2 align-items-center flex-wrap">
                    <input type="text" id="userSearch" class="form-control" placeholder="Search users by username..." style="flex: 1; min-width: 200px;">
                    <select id="roleFilter" class="form-select" style="width: auto; min-width: 150px;">
                        <option value="">All Roles</option>
                        <option value="admin">Admin</option>
                        <option value="master">Master</option>
                        <option value="user">User</option>
                    </select>
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="columnDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Edit Columns
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="columnDropdown">
                            <li>
                                <div class="form-check ms-3">
                                    <input class="form-check-input column-toggle" type="checkbox" id="toggleUsername" data-column="username" ${visibleColumns.username ? 'checked' : ''}>
                                    <label class="form-check-label" for="toggleUsername">Username</label>
                                </div>
                            </li>
                            <li>
                                <div class="form-check ms-3">
                                    <input class="form-check-input column-toggle" type="checkbox" id="toggleRole" data-column="role" ${visibleColumns.role ? 'checked' : ''}>
                                    <label class="form-check-label" for="toggleRole">Role</label>
                                </div>
                            </li>
                            <li>
                                <div class="form-check ms-3">
                                    <input class="form-check-input column-toggle" type="checkbox" id="toggleAction" data-column="action" ${visibleColumns.action ? 'checked' : ''}>
                                    <label class="form-check-label" for="toggleAction">Action</label>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                <table class="table table-bordered table-striped" id="usersTable">
                    <thead>
                        <tr>
                            ${visibleColumns.username ? '<th class="sortable" data-sort="username">Username</th>' : ''}
                            ${visibleColumns.role ? '<th class="sortable" data-sort="role">Role</th>' : ''}
                            ${visibleColumns.action ? '<th>Action</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
            `;

            users.forEach(u => {
                html += `
                    <tr>
                        ${visibleColumns.username ? `<td class="username">${u.username}</td>` : ''}
                        ${visibleColumns.role ? `<td class="role">${u.role}</td>` : ''}
                        ${visibleColumns.action ? `<td class="action"><button class="btn btn-sm btn-primary view-btn" data-id="${u.id}">View Permissions</button></td>` : ''}
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            html += `
                <nav aria-label="User pagination">
                    <ul class="pagination">
                        <li class="page-item ${page === 1 ? 'disabled' : ''}">
                            <button class="page-link" ${page === 1 ? 'disabled' : ''} data-page="${page - 1}">Previous</button>
                        </li>
            `;

            let startPage = Math.max(1, page - 1);
            let endPage = Math.min(totalPages, startPage + 1);
            if (endPage - startPage < 1 && startPage > 1) {
                startPage = Math.max(1, endPage - 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === page ? 'active' : ''}">
                        <button class="page-link" data-page="${i}">${i}</button>
                    </li>
                `;
            }

            html += `
                        <li class="page-item ${page === totalPages ? 'disabled' : ''}">
                            <button class="page-link" ${page === totalPages ? 'disabled' : ''} data-page="${page + 1}">Next</button>
                        </li>
                    </ul>
                </nav>
<div class="d-flex justify-content-center align-items-center gap-2 mt-2">
    <span>Total Pages: ${totalPages}</span>
    <div class="input-group input-group-sm" style="width: 120px;">
        <input type="number" id="pageSearch" class="form-control" placeholder="Page" min="1" max="${totalPages}">
        <button class="btn btn-primary btn-sm" id="goToPageBtn">Go</button>
    </div>
</div>

            `;

            document.getElementById("mainContent").innerHTML = html;

            // Set role filter value if provided
            if (roleFilter) {
                document.getElementById("roleFilter").value = roleFilter;
            }

            document.querySelectorAll(".column-toggle").forEach(checkbox => {
                checkbox.addEventListener("change", () => {
                    const column = checkbox.dataset.column;
                    const countVisible = Array.from(document.querySelectorAll(".column-toggle")).filter(cb => cb.checked).length;
                    if (!checkbox.checked && countVisible <= 1) {
                        alert("At least one column must be visible!");
                        checkbox.checked = true;
                        return;
                    }
                    visibleColumns[column] = checkbox.checked;
                    localStorage.setItem("visibleColumns", JSON.stringify(visibleColumns));
                    loadUserPermissionsOverview(page, document.getElementById("roleFilter").value);
                });
            });

            document.querySelectorAll(".view-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const userId = btn.dataset.id;
                    loadUserPermissionsDetail(userId);
                });
            });

            // Role filter event listener
            document.getElementById("roleFilter").addEventListener("change", () => {
                const selectedRole = document.getElementById("roleFilter").value;
                localStorage.setItem("currentPage", "userPermissions");
                loadUserPermissionsOverview(1, selectedRole);
            });

            // Page search event listeners
            document.getElementById("goToPageBtn")?.addEventListener("click", () => {
                const pageInput = document.getElementById("pageSearch").value;
                const newPage = parseInt(pageInput);
                if (newPage >= 1 && newPage <= totalPages) {
                    localStorage.setItem("currentPage", "userPermissions");
                    loadUserPermissionsOverview(newPage, document.getElementById("roleFilter").value);
                } else {
                    showErrorToast(`Please enter a page number between 1 and ${totalPages}`);
                }
            });

            document.getElementById("pageSearch")?.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    const pageInput = document.getElementById("pageSearch").value;
                    const newPage = parseInt(pageInput);
                    if (newPage >= 1 && newPage <= totalPages) {
                        localStorage.setItem("currentPage", "userPermissions");
                        loadUserPermissionsOverview(newPage, document.getElementById("roleFilter").value);
                    } else {
                        showErrorToast(`Please enter a page number between 1 and ${totalPages}`);
                    }
                }
            });

            const searchInput = document.getElementById("userSearch");
            searchInput.addEventListener("input", async () => {
                const query = searchInput.value.trim();
                const selectedRole = document.getElementById("roleFilter").value;
                try {
                    const queryParams = new URLSearchParams({
                        search: query,
                        page: page,
                        limit: usersPerPage
                    });
                    if (selectedRole) queryParams.append('role', selectedRole);
                    const res = await fetch(`http://localhost:3000/users?${queryParams.toString()}`, {
                        headers: { "Authorization": `Bearer ${token}` }
                    });
                    if (!res.ok) throw new Error("Failed to fetch users");

                    const data = await res.json();
                    if (!Array.isArray(data.users)) {
                        console.error("Expected users to be an array, got:", data.users);
                        document.querySelector("#usersTable tbody").innerHTML = `<tr><td colspan="${Object.values(visibleColumns).filter(v => v).length}" class="text-danger">Invalid user data</td></tr>`;
                        return;
                    }
                    users = data.users;
                    totalPages = data.totalPages || Math.ceil(data.totalUsers / usersPerPage);

                    const tbody = document.querySelector("#usersTable tbody");
                    tbody.innerHTML = users.map(u => `
                        <tr>
                            ${visibleColumns.username ? `<td class="username">${u.username}</td>` : ''}
                            ${visibleColumns.role ? `<td class="role">${u.role}</td>` : ''}
                            ${visibleColumns.action ? `<td class="action"><button class="btn btn-sm btn-primary view-btn" data-id="${u.id}">View Permissions</button></td>` : ''}
                        </tr>
                    `).join("");

                    const pagination = document.querySelector(".pagination");
                    pagination.innerHTML = `
                        <li class="page-item ${page === 1 ? 'disabled' : ''}">
                            <button class="page-link" ${page === 1 ? 'disabled' : ''} data-page="${page - 1}">Previous</button>
                        </li>
                    `;

                    for (let i = startPage; i <= endPage; i++) {
                        pagination.innerHTML += `
                            <li class="page-item ${i === page ? 'active' : ''}">
                                <button class="page-link" data-page="${i}">${i}</button>
                            </li>
                        `;
                    }

                    pagination.innerHTML += `
                        <li class="page-item ${page === totalPages ? 'disabled' : ''}">
                            <button class="page-link" ${page === totalPages ? 'disabled' : ''} data-page="${page + 1}">Next</button>
                        </li>
                    `;

                    // Update total pages and page search input
                    const pageSearchSection = document.querySelector(".d-flex.justify-content-center.align-items-center.gap-2.mt-2");
                    pageSearchSection.innerHTML = `
                        <span>Total Pages: ${totalPages}</span>
                        <div class="input-group input-group-sm w-25">
                            <input type="number" id="pageSearch" class="form-control" placeholder="Go to page" min="1" max="${totalPages}">
                            <button class="btn btn-primary" id="goToPageBtn">Go</button>
                        </div>
                    `;

                    document.getElementById("goToPageBtn")?.addEventListener("click", () => {
                        const pageInput = document.getElementById("pageSearch").value;
                        const newPage = parseInt(pageInput);
                        if (newPage >= 1 && newPage <= totalPages) {
                            localStorage.setItem("currentPage", "userPermissions");
                            loadUserPermissionsOverview(newPage, selectedRole);
                        } else {
                            showErrorToast(`Please enter a page number between 1 and ${totalPages}`);
                        }
                    });

                    document.getElementById("pageSearch")?.addEventListener("keypress", (e) => {
                        if (e.key === "Enter") {
                            const pageInput = document.getElementById("pageSearch").value;
                            const newPage = parseInt(pageInput);
                            if (newPage >= 1 && newPage <= totalPages) {
                                localStorage.setItem("currentPage", "userPermissions");
                                loadUserPermissionsOverview(newPage, selectedRole);
                            } else {
                                showErrorToast(`Please enter a page number between 1 and ${totalPages}`);
                            }
                        }
                    });

                    document.querySelectorAll(".page-link").forEach(button => {
                        button.addEventListener("click", () => {
                            const newPage = parseInt(button.dataset.page);
                            if (newPage) {
                                localStorage.setItem("currentPage", "userPermissions");
                                loadUserPermissionsOverview(newPage, selectedRole);
                            }
                        });
                    });

                    document.querySelectorAll(".view-btn").forEach(btn => {
                        btn.addEventListener("click", () => {
                            loadUserPermissionsDetail(btn.dataset.id);
                        });
                    });
                } catch (err) {
                    console.error(err);
                    document.querySelector("#usersTable tbody").innerHTML = `<tr><td colspan="${Object.values(visibleColumns).filter(v => v).length}" class="text-danger">Error loading users</td></tr>`;
                }
            });

            let sortDirection = { username: 1, role: 1 };
            const sortTable = (column, direction) => {
                if (!visibleColumns[column]) return;
                const tbody = document.querySelector("#usersTable tbody");
                const rows = Array.from(tbody.querySelectorAll("tr"));

                rows.sort((a, b) => {
                    const colIndex = column === "username" && visibleColumns.username ? 0 : 
                                    column === "role" && visibleColumns.role ? (visibleColumns.username ? 1 : 0) : -1;
                    if (colIndex === -1) return 0;
                    const aValue = a.cells[colIndex].textContent.toLowerCase();
                    const bValue = b.cells[colIndex].textContent.toLowerCase();
                    return direction * (aValue > bValue ? 1 : aValue < bValue ? -1 : 0);
                });

                tbody.innerHTML = "";
                rows.forEach(row => tbody.appendChild(row));
            };

            document.querySelectorAll(".sortable").forEach(header => {
                header.addEventListener("click", () => {
                    const column = header.dataset.sort;
                    if (!visibleColumns[column]) return;
                    sortDirection[column] = sortDirection[column] === 1 ? -1 : 1;

                    document.querySelectorAll(".sortable").forEach(h => {
                        h.classList.remove("asc", "desc");
                    });
                    header.classList.add(sortDirection[column] === 1 ? "asc" : "desc");

                    sortTable(column, sortDirection[column]);
                });
            });

            document.querySelectorAll(".page-link").forEach(button => {
                button.addEventListener("click", () => {
                    const newPage = parseInt(button.dataset.page);
                    if (newPage) {
                        localStorage.setItem("currentPage", "userPermissions");
                        loadUserPermissionsOverview(newPage, document.getElementById("roleFilter").value);
                    }
                });
            });
        }

        async function loadUserPermissionsDetail(userId) {
            const token = getToken();
            if (!token) return showLoginRequiredMessage();

            let user;
            try {
                const res = await fetch(`http://localhost:3000/users/${userId}`, { 
                    headers: { "Authorization": `Bearer ${token}` } 
                });

                if (!res.ok) {
                    document.getElementById("mainContent").innerHTML = `
                        <p class="text-danger">‚ö†Ô∏è Failed to load user details (ID: ${userId})</p>
                    `;
                    return;
                }

                user = await res.json();
            } catch (err) {
                console.error("Error fetching user:", err);
                document.getElementById("mainContent").innerHTML = `
                    <p class="text-danger">‚ö†Ô∏è Error fetching user data</p>
                `;
                return;
            }

            const permissions = [
                { key: "can_add_stock", label: "Add Stock", value: user.can_add_stock },
                { key: "can_view_stock", label: "View Stock", value: user.can_view_stock },
                { key: "can_edit_stock", label: "Edit Stock", value: user.can_edit_stock },
                { key: "can_delete_stock", label: "Delete Stock", value: user.can_delete_stock },
                { key: "can_add_department", label: "Add Department", value: user.can_add_department },
                { key: "can_assign_department_member", label: "Assign Department Member", value: user.can_assign_department_member }
            ];

            permissions.sort((a, b) => b.value - a.value);

            let html = `
                <h2>Permissions for ${user.username}</h2>
                <ul id="permList" class="list-group mb-3">
            `;

            permissions.forEach(p => {
                html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center" data-key="${p.key}">
                        <span>${p.label}</span>
                        <input type="checkbox" class="perm-checkbox" ${p.value ? "checked" : ""}>
                    </li>
                `;
            });

            html += `</ul>
                <button id="savePermsBtn" class="btn btn-success">Save</button>
                <button id="backBtn" class="btn btn-secondary ms-2">Back</button>
            `;

            document.getElementById("mainContent").innerHTML = html;

            if (window.$) {
                $("#permList").sortable();
                $("#permList").disableSelection();
            }

            document.getElementById("savePermsBtn").addEventListener("click", async () => {
                const data = {};
                document.querySelectorAll("#permList li").forEach(li => {
                    const key = li.dataset.key;
                    data[key] = li.querySelector(".perm-checkbox").checked ? 1 : 0;
                });

                try {
                    const updateRes = await fetch(`http://localhost:3000/users/${userId}`, {
                        method: "PUT",
                        headers: { 
                            "Content-Type": "application/json", 
                            "Authorization": `Bearer ${token}` 
                        },
                        body: JSON.stringify(data)
                    });

                    if (updateRes.ok) {
                        alert("Permissions updated!");
                        localStorage.setItem("currentPage", "userPermissions");
                        loadUserPermissionsOverview();
                    } else {
                        const errText = await updateRes.text();
                        alert("Failed to update permissions: " + errText);
                    }
                } catch (err) {
                    console.error("Error updating permissions:", err);
                    alert("Error updating permissions");
                }
            });

            document.getElementById("backBtn").addEventListener("click", () => {
                localStorage.setItem("currentPage", "userPermissions");
                loadUserPermissionsOverview();
            });
        }

async function loadProfile() {
    if (!currentUser) return showLoginRequiredMessage();

    const token = getToken();
    if (!token) return showLoginRequiredMessage();

    let userDepartments = [];
    try {
        const deptRes = await fetch(`http://localhost:3000/api/departments?t=${Date.now()}`, {
            headers: { Authorization: `Bearer ${token}` }
        });
        if (!deptRes.ok) {
            throw new Error(`Failed to load departments: ${deptRes.statusText}`);
        }
        const depts = await deptRes.json();
        // Filter departments where the current user's username is in the members list
        userDepartments = depts.filter(dept => 
            dept.members && dept.members.split(',').includes(currentUser.username)
        ).map(dept => dept.name);
    } catch (err) {
        console.error("Error fetching departments for profile:", err);
        userDepartments = []; // Fallback to empty array to avoid breaking the UI
        showErrorToast("Failed to load department information");
    }

    document.getElementById("mainContent").innerHTML = `
        <div class="card shadow-lg border-0 rounded-4 w-75 mx-auto">
            <div class="card-header bg-primary text-white text-center rounded-top-4">
                <h3 class="mb-0"><i class="fa-solid fa-user-circle me-2"></i> Profile</h3>
            </div>
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-4">
                    <div class="me-3">
                        <i class="fa-solid fa-circle-user fa-4x text-secondary"></i>
                    </div>
                    <div>
                        <h4 class="mb-1">${currentUser.username}</h4>
                        <span class="badge bg-info text-dark">${currentUser.role}</span>
                    </div>
                </div>
                <h5 class="mb-3">Departments</h5>
                <div class="mb-4">
                    ${
                        userDepartments.length > 0
                            ? `<div class="members-container">
                                 ${userDepartments.map(dept => `<span class="badge bg-secondary me-1">${dept}</span>`).join('')}
                               </div>`
                            : '<p class="text-muted">Not assigned to any department</p>'
                    }
                </div>
                <h5 class="mb-3">Permissions</h5>
                <table class="table table-bordered align-middle">
                    <tbody>
                        <tr><th>Can Add Stock</th><td>${formatPermission(currentUser.can_add_stock)}</td></tr>
                        <tr><th>Can View Stock</th><td>${formatPermission(currentUser.can_view_stock)}</td></tr>
                        <tr><th>Can Edit Stock</th><td>${formatPermission(currentUser.can_edit_stock)}</td></tr>
                        <tr><th>Can Delete Stock</th><td>${formatPermission(currentUser.can_delete_stock)}</td></tr>
                        <tr><th>Can Add Department</th><td>${formatPermission(currentUser.can_add_department)}</td></tr>
                        <tr><th>Can Assign Department Member</th><td>${formatPermission(currentUser.can_assign_department_member)}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

        // Helper function for cleaner code
        function formatPermission(flag) {
            return flag 
                ? `<span class="badge bg-success"><i class="fa-solid fa-check me-1"></i> Yes</span>` 
                : `<span class="badge bg-danger"><i class="fa-solid fa-xmark me-1"></i> No</span>`;
        }

async function loadDepartments() {
    const token = getToken();
    if (!token) return showLoginRequiredMessage();

    document.getElementById("mainContent").innerHTML = `<h3>Departments</h3><p>‚è≥ Loading departments...</p>`;

    try {
        // Fetch departments with cache-busting
        const deptRes = await fetch(`http://localhost:3000/api/departments?t=${Date.now()}`, {
            headers: { Authorization: `Bearer ${token}` }
        });
        if (!deptRes.ok) {
            throw new Error(`Failed to load departments: ${deptRes.statusText}`);
        }
        const depts = await deptRes.json();

        // Fetch all users for assignment dropdown
        const usersRes = await fetch(`http://localhost:3000/users?page=1&limit=1000&t=${Date.now()}`, {
            headers: { Authorization: `Bearer ${token}` }
        });
        if (!usersRes.ok) {
            throw new Error(`Failed to load users: ${usersRes.statusText}`);
        }
        const usersData = await usersRes.json();
        const users = Array.isArray(usersData.users) ? usersData.users : [];

        let html = `
            <div class="card">
                <div class="card-header bg-primary text-white"><h4 class="mb-0">Departments</h4></div>
                <div class="card-body">
                    <div id="deptAddSection" class="mb-3 d-flex gap-2">
                        <input type="text" id="deptName" class="form-control" placeholder="Enter department name">
                        <button id="addDeptBtn" class="btn btn-success">Add</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Members</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
        `;

        for (const dept of depts) {
            if (!dept.id || isNaN(dept.id)) {
                console.error(`Invalid department ID for ${dept.name}:`, dept.id);
                continue;
            }
            const members = dept.members ? dept.members.split(',').map(username => ({
                id: users.find(u => u.username === username)?.id || null,
                username
            })) : [];
            console.log(`Rendering dept ${dept.name} with members:`, members);

            html += `
                <tr>
                    <td>${dept.name}</td>
                    <td>
                        <div class="members-container">
                            ${members.length > 0 
                                ? members.map(m => `
                                    <span class="badge bg-secondary me-1">
                                        ${m.username}
                                        ${m.id && (currentUser.role === "master" || currentUser.can_assign_department_member)
                                            ? `<button class="btn btn-sm btn-danger remove-member-btn ms-1" data-dept-id="${dept.id}" data-user-id="${m.id}"><i class="fas fa-times"></i></button>`
                                            : ''
                                        }
                                    </span>
                                  `).join('')
                                : 'No members'
                            }
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${currentUser.role === "master" || currentUser.can_assign_department_member
                                ? `<button class="btn btn-sm btn-primary assign-btn me-1" data-id="${dept.id}" data-members="${dept.members || ''}" data-bs-toggle="modal" data-bs-target="#assignMemberModal">Assign Member</button>`
                                : ''
                            }
                            ${currentUser.role === "master" || currentUser.can_delete_department
                                ? `<button class="btn btn-sm btn-danger delete-btn" data-id="${dept.id}" data-bs-toggle="modal" data-bs-target="#deleteDeptModal">delete</button>`
                                : `<button class="btn btn-sm btn-secondary" disabled>Locked</button>`
                            }
                        </div>
                    </td>
                </tr>
            `;
        }

        html += `</tbody></table></div></div></div>`;
        document.getElementById("mainContent").innerHTML = html;

        if (currentUser.role !== "master" && !currentUser.can_add_department) {
            document.getElementById("deptAddSection").style.display = "none";
        }

        // Add Department
        document.getElementById("addDeptBtn")?.addEventListener("click", async () => {
            const name = document.getElementById("deptName").value.trim();
            if (!name) {
                showErrorToast("Enter a department name");
                return;
            }
            try {
                const res = await fetch("http://localhost:3000/api/departments", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    showDeactivateDeptToast();
                    loadDepartments();
                } else {
                    const errText = await res.text();
                    showErrorToast(errText || "Failed to add department");
                }
            } catch (err) {
                console.error("Error adding department:", err);
                showErrorToast("Error adding department");
            }
        });

        // Deactivate Department
        let deptIdToDelete = null;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteDeptModal'));
        document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                deptIdToDelete = btn.dataset.id;
                deleteModal.show();
            });
        });

        document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
            if (!deptIdToDelete) return;
            try {
                const delRes = await fetch(`http://localhost:3000/api/departments/${deptIdToDelete}?t=${Date.now()}`, {
                    method: "DELETE",
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (delRes.ok) {
                    showDeactivateDeptToast();
                    loadDepartments();
                } else {
                    const errText = await delRes.text();
                    showErrorToast(errText || "Failed to deactivate department");
                }
            } catch (err) {
                console.error("Error deactivating department:", err);
                showErrorToast("Error deactivating department");
            }
            deleteModal.hide();
            deptIdToDelete = null;
        });

        // Assign Member
        let deptIdToAssign = null;
        const assignModal = new bootstrap.Modal(document.getElementById('assignMemberModal'));
        const confirmAssignBtn = document.getElementById("confirmAssignBtn");
        // Clear previous event listeners to prevent duplicates
        confirmAssignBtn.replaceWith(confirmAssignBtn.cloneNode(true));
        const newConfirmAssignBtn = document.getElementById("confirmAssignBtn");

        // Disable confirm button by default
        newConfirmAssignBtn.disabled = true;

        document.querySelectorAll(".assign-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                deptIdToAssign = btn.dataset.id;
                if (!deptIdToAssign || isNaN(deptIdToAssign)) {
                    console.error("Assign button clicked with invalid deptId:", btn.dataset.id, btn);
                    showErrorToast("Invalid department selected");
                    return;
                }
                const assignedMembers = btn.dataset.members ? btn.dataset.members.split(',') : [];
                console.log(`Assign modal opened for dept ${deptIdToAssign}, excluding:`, assignedMembers);
                fetch(`http://localhost:3000/users?page=1&limit=1000&t=${Date.now()}`, {
                    headers: { Authorization: `Bearer ${token}` }
                })
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to fetch users");
                        return res.json();
                    })
                    .then(data => {
                        const users = Array.isArray(data.users) ? data.users : [];
                        const userSelect = document.getElementById("userSelect");
                        userSelect.innerHTML = '<option value="">Select a user</option>';
                        users
                            .filter(user => !assignedMembers.includes(user.username))
                            .forEach(user => {
                                userSelect.innerHTML += `<option value="${user.id}">${user.username}</option>`;
                            });
                        // Enable confirm button only if deptIdToAssign is valid
                        newConfirmAssignBtn.disabled = !deptIdToAssign;
                        assignModal.show();
                    })
                    .catch(err => {
                        console.error("Error fetching users for dropdown:", err);
                        showErrorToast("Failed to load users for assignment");
                        newConfirmAssignBtn.disabled = true;
                    });
            });
        });

        // Update confirm button state based on user selection
        document.getElementById("userSelect").addEventListener("change", () => {
            const userId = document.getElementById("userSelect").value;
            newConfirmAssignBtn.disabled = !deptIdToAssign || !userId;
        });

        newConfirmAssignBtn.addEventListener("click", async () => {
            if (!deptIdToAssign) {
                console.error("Confirm assign clicked with null deptIdToAssign");
                showErrorToast("No department selected for assignment");
                assignModal.hide();
                return;
            }
            const userId = document.getElementById("userSelect").value;
            if (!userId) {
                showErrorToast("Please select a user");
                return;
            }
            console.log(`Attempting to assign user ${userId} to dept ${deptIdToAssign}`);
            try {
                const res = await fetch(`http://localhost:3000/api/departments/${deptIdToAssign}/assign?t=${Date.now()}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
                    body: JSON.stringify({ userId })
                });
                if (res.ok) {
                    showAssignMemberToast();
                    loadDepartments();
                } else {
                    const errText = await res.text();
                    showErrorToast(errText || "Failed to assign member");
                }
            } catch (err) {
                console.error("Error assigning member:", err);
                showErrorToast("Error assigning member");
            } finally {
                assignModal.hide();
                deptIdToAssign = null;
                newConfirmAssignBtn.disabled = true;
            }
        });

        // Reset deptIdToAssign only after modal is fully hidden
        assignModal._element.addEventListener('hidden.bs.modal', () => {
            console.log("Assign modal hidden, resetting deptIdToAssign");
            deptIdToAssign = null;
            newConfirmAssignBtn.disabled = true;
        });

        // Remove Member
        document.querySelectorAll(".remove-member-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                const deptId = btn.dataset.deptId;
                const userId = btn.dataset.userId;
                try {
                    const res = await fetch(`http://localhost:3000/api/departments/${deptId}/members/${userId}?t=${Date.now()}`, {
                        method: "DELETE",
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    if (res.ok) {
                        showRemoveMemberToast();
                        loadDepartments();
                    } else {
                        const errText = await res.text();
                        showErrorToast(errText || "Failed to remove member");
                    }
                } catch (err) {
                    console.error("Error removing member:", err);
                    showErrorToast("Error removing member");
                }
            });
        });

    } catch (err) {
        console.error("Error loading departments:", err);
        document.getElementById("mainContent").innerHTML = `<h3>Departments</h3><p class="text-danger">‚ö†Ô∏è Failed to load departments: ${err.message}</p>`;
        showErrorToast("Failed to load departments");
    }
}

        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return "Good Morning";
            if (hour < 18) return "Good Afternoon";
            return "Good Evening";
        }

        function updateClock() {
            const now = new Date();
            const hours = now.getHours() % 12 || 12;
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const ampm = now.getHours() >= 12 ? 'PM' : 'AM';
            const timeString = `${hours}:${minutes}:${seconds} ${ampm}`;
            const clockElement = document.getElementById("clock");
            if (clockElement) {
                clockElement.textContent = timeString;
            }
        }

        async function loadDashboard() {
            const user = await fetchCurrentUser();
            if (!user) return showLoginRequiredMessage();

            document.getElementById("mainContent").innerHTML = `
                <div class="mb-4">
                    <h2>${getGreeting()}, ${user.username} üëã</h2>
                    <p>Here‚Äôs a quick overview of your system. Current time: <span id="clock" class="badge bg-primary"></span></p>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card p-3 shadow-sm">
                            <h5>Department Overview</h5>
                            <div style="height:300px">
                                <canvas id="deptChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3 shadow-sm">
                            <h5>User Roles</h5>
                            <div style="height:300px">
                                <canvas id="roleChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12 col-md-6 mx-auto">
                        <div class="card p-3 shadow-sm">
                            <h5>Calendar</h5>
                            <div id="calendar" class="calendar-container"></div>
                        </div>
                    </div>
                </div>
            `;

            updateClock();
            if (clockInterval) clearInterval(clockInterval);
            clockInterval = setInterval(updateClock, 1000);

            if (deptChartInstance) deptChartInstance.destroy();
            if (roleChartInstance) roleChartInstance.destroy();

            try {
                const deptCtx = document.getElementById("deptChart").getContext("2d");
                deptChartInstance = new Chart(deptCtx, {
                    type: "bar",
                    data: {
                        labels: ["IT", "HR", "Sales", "Marketing", "Finance"],
                        datasets: [{
                            label: "Members",
                            data: [12, 8, 15, 7, 10],
                            backgroundColor: "rgba(54, 162, 235, 0.7)"
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch (err) {
                console.error("Error initializing department chart:", err);
            }

            try {
                const roleCtx = document.getElementById("roleChart").getContext("2d");
                roleChartInstance = new Chart(roleCtx, {
                    type: "pie",
                    data: {
                        labels: ["Admin", "Manager", "Staff"],
                        datasets: [{
                            data: [3, 5, 12],
                            backgroundColor: [
                                "rgba(255, 99, 132, 0.7)",
                                "rgba(54, 162, 235, 0.7)",
                                "rgba(255, 206, 86, 0.7)"
                            ]
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch (err) {
                console.error("Error initializing role chart:", err);
            }

            const initializeCalendar = (attempt = 1, maxAttempts = 5) => {
                try {
                    if (typeof FullCalendar === "undefined") {
                        if (attempt < maxAttempts) {
                            console.warn(`FullCalendar not loaded, retrying (${attempt}/${maxAttempts})...`);
                            setTimeout(() => initializeCalendar(attempt + 1, maxAttempts), 500);
                            return;
                        } else {
                            console.error("FullCalendar library failed to load after multiple attempts.");
                            document.getElementById("calendar").innerHTML = `
                                <p class="text-danger">‚ö†Ô∏è Failed to load calendar. Please check your internet connection and try again.</p>
                            `;
                            return;
                        }
                    }

                    if (calendar) calendar.destroy();
                    const calendarEl = document.getElementById("calendar");
                    if (!calendarEl) {
                        console.error("Calendar element not found!");
                        document.getElementById("calendar").innerHTML = `
                            <p class="text-danger">‚ö†Ô∏è Calendar container not found.</p>
                        `;
                        return;
                    }

                    calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        height: 'auto',
                        dayMaxEvents: 2,
                        events: [
                            { title: 'Team Meeting', start: '2025-08-21' },
                            { title: 'Project Deadline', start: '2025-08-25' },
                            { title: 'HR Event', start: '2025-08-28' }
                        ],
                        eventDisplay: 'block',
                        headerToolbar: {
                            left: 'prev,next',
                            center: 'title',
                            right: 'dayGridMonth'
                        },
                        eventTimeFormat: {
                            hour: 'numeric',
                            minute: '2-digit',
                            meridiem: 'short'
                        },
                        displayEventTime: false,
                        eventDidMount: function(info) {
                            info.el.style.fontSize = window.innerWidth <= 767 ? '0.8em' : '0.9em';
                        }
                    });

                    calendar.render();
                    console.log("Calendar initialized successfully on attempt", attempt);

                    window.addEventListener('resize', () => {
                        if (calendar) {
                            calendar.updateSize();
                        }
                    });
                } catch (err) {
                    console.error("Error initializing calendar:", err);
                    document.getElementById("calendar").innerHTML = `
                        <p class="text-danger">‚ö†Ô∏è Error loading calendar: ${err.message}</p>
                    `;
                }
            };

            setTimeout(() => initializeCalendar(), 100);
        }

        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem("token");
            localStorage.removeItem("currentPage");
            localStorage.removeItem("visibleColumns");
            currentUser = null;
            showLoginRequiredMessage();
            showLogoutToast();
            setTimeout(() => {
                window.location.href = "login.html";
            }, 1000);
            if (clockInterval) clearInterval(clockInterval);
        });

        document.getElementById("dashboardLink").addEventListener("click", (e) => {
            e.preventDefault();
            localStorage.setItem("currentPage", "dashboard");
            document.getElementById("mainContent").innerHTML = `
                <div class="text-center my-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p>Loading dashboard...</p>
                </div>
            `;
            handleMenuClick(loadDashboard);
        });

        document.getElementById("departmentLink").addEventListener("click", async (e) => {
            e.preventDefault();
            localStorage.setItem("currentPage", "departments");
            document.getElementById("mainContent").innerHTML = `
                <div class="text-center my-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p>Loading departments...</p>
                </div>
            `;
            if (clockInterval) clearInterval(clockInterval);
            handleMenuClick(loadDepartments);
        });

        document.getElementById("userPermissionLink").addEventListener("click", (e) => {
            e.preventDefault();
            localStorage.setItem("currentPage", "userPermissions");
            document.getElementById("mainContent").innerHTML = `
                <div class="text-center my-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p>Loading user permissions...</p>
                </div>
            `;
            if (clockInterval) clearInterval(clockInterval);
            handleMenuClick(() => loadUserPermissionsOverview(1));
        });

        document.getElementById("profileLink").addEventListener("click", (e) => {
            e.preventDefault();
            localStorage.setItem("currentPage", "profile");
            if (clockInterval) clearInterval(clockInterval);
            handleMenuClick(loadProfile);
        });

        window.addEventListener("DOMContentLoaded", initialLoad);

        async function initialLoad() {
            const currentPage = localStorage.getItem("currentPage") || "dashboard";
            const user = await fetchCurrentUser();

            if (!user) {
                showLoginRequiredMessage();
                return;
            }

            showLoginToast();

            document.getElementById("mainContent").innerHTML = `
                <div class="text-center my-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p>Loading ${currentPage}...</p>
                </div>
            `;

            switch (currentPage) {
                case "dashboard":
                    loadDashboard();
                    break;
                case "departments":
                    if (clockInterval) clearInterval(clockInterval);
                    loadDepartments();
                    break;
                case "userPermissions":
                    if (clockInterval) clearInterval(clockInterval);
                    loadUserPermissionsOverview(1);
                    break;
                case "profile":
                    if (clockInterval) clearInterval(clockInterval);
                    loadProfile();
                    break;
                default:
                    loadDashboard();
                    break;
            }

            initializeToast();
        }
    </script>
</body>
</html>